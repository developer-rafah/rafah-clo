<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ØªØ¨Ø±Ø¹ ÙØ§Ø¦Ø¶ Ø§Ù„Ù…Ù„Ø§Ø¨Ø³ | Ø¬Ù…Ø¹ÙŠØ© Ø±ÙØ§Ù‡</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
:root{
  --bg:#0e0b14;
  --bg2:#1a1326;
  --p:#7a5ea8;
  --s:#b88fcf;
  --txt:#f3f4f6;
  --muted:#b6b1c6;
  --wa:#25D366;

  /* Ø¥Ø¶Ø§ÙØ§Øª */
  --ok:#34d399;
  --err:#fb7185;
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Tajawal",sans-serif;
  color:var(--txt);
  background:
    radial-gradient(700px 400px at 80% 20%, rgba(184,143,207,.16), transparent 60%),
    linear-gradient(180deg,var(--bg),var(--bg2));
}

/* Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
.entry-popup{
  position:fixed; inset:0;
  display:flex;align-items:center;justify-content:center;
  background:rgba(0,0,0,.55);
  backdrop-filter:blur(8px);
  z-index:9999;
}
.entry-box{
  max-width:320px;
  padding:18px 22px;
  border-radius:18px;
  background:linear-gradient(135deg,var(--p),var(--s));
  font-size:16px;
  font-weight:800;
  text-align:center;
  animation:scaleUp .4s ease;
}
@keyframes scaleUp{
  from{transform:scale(.9);opacity:0}
  to{transform:scale(1);opacity:1}
}

/* Scroll Reveal */
.reveal{opacity:0;transform:translateY(22px);transition:.8s}
.reveal.show{opacity:1;transform:none}

/* Ø§Ù„ØªØ®Ø·ÙŠØ· */
.wrap{min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px}
.card{
  width:min(1050px,100%);
  background:rgba(255,255,255,.05);
  border:1px solid rgba(255,255,255,.15);
  backdrop-filter:blur(14px);
  border-radius:30px;
  display:grid;
  grid-template-columns:1fr 1fr;
}
@media(max-width:900px){.card{grid-template-columns:1fr}}

.content{padding:40px;text-align:center}
.logo{
  max-width:170px;
  margin:0 auto 26px;
  display:block;
  animation:breath 4s ease-in-out infinite;
}
@keyframes breath{
  0%,100%{transform:scale(1)}
  50%{transform:scale(1.04)}
}

h1{
  font-size:clamp(26px,4vw,40px);
  font-weight:900;
  background:linear-gradient(90deg,#fff,var(--s));
  -webkit-background-clip:text;
  color:transparent;
}
p{line-height:1.9;color:#e5e7eb}

.btn{
  margin-top:28px;
  padding:15px 28px;
  font-size:17px;
  font-weight:900;
  border:none;
  border-radius:999px;
  cursor:pointer;
  color:#fff;
  background:linear-gradient(135deg,var(--p),var(--s));
  box-shadow:0 10px 28px rgba(184,143,207,.35);
}

/* Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„ØªÙØ§Ø¹Ù„ÙŠ */
.visual{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:32px;
}
.impact{
  width:140px;
  height:140px;
  border-radius:50%;
  border:1.2px dashed rgba(255,255,255,.22);
  display:flex;
  align-items:center;
  justify-content:center;
  position:relative;
  overflow:hidden;
}
.impact span{
  position:absolute;
  font-weight:900;
  font-size:15px;
  opacity:0;
  transform:scale(.9);
  animation:impactFade 2.6s ease-in-out infinite;
}
@keyframes impactFade{
  0%{opacity:0;transform:scale(.9)}
  20%{opacity:1;transform:scale(1)}
  80%{opacity:1;transform:scale(1)}
  100%{opacity:0;transform:scale(1.05)}
}

/* Ø§Ù„Ù†ÙˆØ§ÙØ° */
.modal{
  position:fixed; inset:0;
  background:rgba(0,0,0,.6);
  backdrop-filter:blur(6px);
  display:none;
  align-items:center; justify-content:center;
  z-index:999;
}
.modal-box{
  width:min(420px,92%);
  background:rgba(255,255,255,.1);
  border:1px solid rgba(255,255,255,.25);
  border-radius:22px;
  padding:24px;
}
input{
  width:100%;
  margin-top:12px;
  padding:13px;
  border-radius:14px;
  border:1px solid rgba(255,255,255,.25);
  background:rgba(0,0,0,.35);
  color:#fff;

  /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø­Ù‚Ù„ */
  padding-left:42px;
}

/* ===== Ø¥Ø¶Ø§ÙØ§Øª Ø¬Ù…Ø§Ù„ÙŠØ© + ØªØ­Ù‚Ù‚ ===== */
.error-text{
  font-size:13px;
  color:var(--err);
  margin-top:6px;
  display:none;
  font-weight:700;
}

input.valid{
  border-color: rgba(52,211,153,.9);
  box-shadow: 0 0 0 3px rgba(52,211,153,.18);
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2334d399' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M20 6 9 17l-5-5'/%3E%3C/svg%3E");
  background-repeat:no-repeat;
  background-position: 12px 50%;
  background-size: 18px 18px;
}

input.invalid{
  border-color: rgba(251,113,133,.95);
  box-shadow: 0 0 0 3px rgba(251,113,133,.16);
}

.shake{
  animation:shake .35s;
}
@keyframes shake{
  0%{transform:translateX(0)}
  25%{transform:translateX(-4px)}
  50%{transform:translateX(4px)}
  75%{transform:translateX(-4px)}
  100%{transform:translateX(0)}
}

/* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
.submit{
  margin-top:14px;
  width:100%;
  padding:14px;
  border-radius:999px;
  border:none;
  font-weight:900;
  background:linear-gradient(135deg,var(--s),var(--p));
  color:#fff;
}
.submit:disabled{
  opacity:.55;
  cursor:not-allowed;
  filter:saturate(.7);
}

/* Ø§Ù„Ø®Ø±ÙŠØ·Ø© */
#map{
  width:100%;
  height:300px;
  border-radius:16px;
  margin-top:12px;
}
.map-hint{
  font-size:14px;
  font-weight:700;
  color:#fff;
  background:rgba(122,94,168,.9);
  padding:10px 14px;
  border-radius:12px;
  text-align:center;
}

/* ======= Ø¥Ø¶Ø§ÙØ§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø®Ø±ÙŠØ·Ø© (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø£ÙŠ Ø´ÙŠØ¡) ======= */
.map-actions{
  display:flex;
  gap:10px;
  margin-top:10px;
}
.map-actions .submit{
  margin-top:0;
  width:auto;
  flex:1;
  padding:12px;
}
#accuracyInfo{
  margin-top:10px;
  font-size:13px;
  font-weight:800;
  text-align:center;
  color:#e5e7eb;
  opacity:.95;
}

/* ÙˆØ§ØªØ³Ø§Ø¨ */
.whatsapp{
  position:fixed;
  bottom:18px;left:18px;
  width:52px;height:52px;
  border-radius:50%;
  background:linear-gradient(135deg,#2eea7b,var(--wa));
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 12px 28px rgba(37,211,102,.45);
}
.whatsapp img{width:26px}

footer{text-align:center;font-size:12px;color:var(--muted);margin:20px}
</style>
</head>

<body>

<div class="entry-popup" id="entryPopup">
  <div class="entry-box">ÙØ§Ø¦Ø¶ Ù…Ù„Ø§Ø¨Ø³ Ø§Ù„ÙŠÙˆÙ…â€¦ Ø³ØªØ±ÙŒ ÙˆØ¯ÙØ¡ Ù„ØºÙŠØ±Ùƒ ğŸ¤</div>
</div>

<div class="wrap">
  <div class="card reveal">
    <div class="content reveal">
      <img src="https://www.rafah.org.sa/rafed/uploads/website_news/1_6952241baa337.png" class="logo" alt="Ø¬Ù…Ø¹ÙŠØ© Ø±ÙØ§Ù‡">
      <h1>ØªØ¨Ø±Ø¹ ÙØ§Ø¦Ø¶ Ø§Ù„Ù…Ù„Ø§Ø¨Ø³</h1>
      <p>ØªØ¨Ø±Ø¹Ùƒ ÙŠØ³Ù‡Ù… ÙÙŠ Ø³ØªØ± Ø§Ù„Ø£Ø³Ø± Ø§Ù„Ù…Ø­ØªØ§Ø¬Ø© ÙˆÙŠØ¹Ø²Ø² Ø§Ù„ØªÙƒØ§ÙÙ„ Ø§Ù„Ù…Ø¬ØªÙ…Ø¹ÙŠ.</p>
      <button class="btn" onclick="openForm()">ØªØ¨Ø±Ø¹ Ø§Ù„Ø¢Ù†</button>
    </div>

    <div class="visual reveal">
      <div class="impact">
        <span id="impactText">Ø£Ø«Ø±Ùƒ Ù…Ø³ØªÙ…Ø±</span>
      </div>
    </div>
  </div>
</div>

<!-- Ù†Ù…ÙˆØ°Ø¬ -->
<div class="modal" id="formModal">
  <div class="modal-box">
    <input placeholder="Ø§Ù„Ø§Ø³Ù…">
    <div class="error-text" id="errName"></div>

    <input placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„">
    <div class="error-text" id="errPhone"></div>

    <input placeholder="Ø§Ù„Ø­ÙŠ">
    <div class="error-text" id="errArea"></div>

    <button class="submit" onclick="openMap()">ğŸ“ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
    <div id="locationStatus" style="margin-top:10px;color:#b88fcf"></div>

    <!-- Ù†ÙØ³ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„ÙƒÙ† Ø³ÙŠØªÙ… ØªØ¹Ø·ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø­ØªÙ‰ ØªÙƒØªÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <button class="submit" onclick="openConfirmModal()" id="submitBtn" disabled>Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

<!-- Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div class="modal" id="mapModal">
  <div class="modal-box">
    <div class="map-hint">
      Ø­Ø±Ù‘Ùƒ Ø§Ù„Ø¯Ø¨ÙˆØ³ ÙˆØ­Ø¯Ø¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØµØ­ÙŠØ­ Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„ØªØ¨Ø±Ø¹
    </div>
    <div id="map"></div>

    <!-- ======= Ø¥Ø¶Ø§ÙØ© Ø¬Ø¯ÙŠØ¯Ø© (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø²Ø± Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ) ======= -->
    <div class="map-actions">
      <button class="submit" onclick="locateNow()">ğŸ“ Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†</button>
      <button class="submit" onclick="confirmLocation()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹</button>
    </div>
    <div id="accuracyInfo"></div>
    <!-- ======= Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ======= -->
  </div>
</div>

<a class="whatsapp" href="https://wa.me/966502333499" target="_blank">
  <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg">
</a>

<footer>Â© 2025 Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¬Ù…Ø¹ÙŠØ© Ø±ÙØ§Ù‡ Ù„Ù„Ø£Ø±Ø§Ù…Ù„ ÙˆØ§Ù„Ù…Ø·Ù„Ù‚Ø§Øª</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
setTimeout(()=>document.getElementById("entryPopup").style.display="none",2600);

/* Scroll Reveal */
const obs=new IntersectionObserver(e=>e.forEach(i=>i.isIntersecting&&i.target.classList.add("show")),{threshold:.15});
document.querySelectorAll(".reveal").forEach(el=>obs.observe(el));

/* Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„Ø£Ø«Ø± */
const impactTexts=["Ø£Ø«Ø±Ùƒ Ù…Ø³ØªÙ…Ø±","Ø¯ÙØ¡ ÙŠØµÙ„","Ø³ØªØ±ÙŒ ÙŠØ¯ÙˆÙ…","Ø®ÙŠØ±ÙŒ ÙŠØªØ¶Ø§Ø¹Ù"];
let idx=0;
setInterval(()=>{
  idx=(idx+1)%impactTexts.length;
  document.getElementById("impactText").textContent=impactTexts[idx];
},2600);

/* Ø§Ù„Ù†ÙˆØ§ÙØ° */
function openForm(){
  document.getElementById("formModal").style.display="flex";
  restoreDraft();       // ğŸ”’ Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­ÙØ¸ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
  validateAll();        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª
}

/* ====== Ø¥Ø¶Ø§ÙØ§Øª: Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ + ØªØ­Ù‚Ù‚ + ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ====== */
const STORAGE_KEY = "rafah_donation_draft_v1";

/* âœ… marker expected (Ù„Ø§Ø²Ù… ÙŠØ·Ø§Ø¨Ù‚ GAS_MARKER ÙÙŠ Apps Script) */
const EXPECTED_GAS_MARKER = "GAS_CODE_v2026_01_05";

const nameInput  = document.querySelector('#formModal input[placeholder="Ø§Ù„Ø§Ø³Ù…"]');
const phoneInput = document.querySelector('#formModal input[placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„"]');
const areaInput  = document.querySelector('#formModal input[placeholder="Ø§Ù„Ø­ÙŠ"]');

const errName  = document.getElementById("errName");
const errPhone = document.getElementById("errPhone");
const errArea  = document.getElementById("errArea");

const submitBtn = document.getElementById("submitBtn");

function hasValidCoords(){
  return Number.isFinite(Number(lat)) && Number.isFinite(Number(lng));
}

function shakeEl(el){
  el.classList.add("shake");
  setTimeout(()=>el.classList.remove("shake"),350);
}
function showErr(inputEl, box, msg){
  box.textContent = msg;
  box.style.display = "block";
  inputEl.classList.add("invalid");
  inputEl.classList.remove("valid");
  shakeEl(inputEl);
}
function clearErr(inputEl, box){
  box.style.display = "none";
  inputEl.classList.remove("invalid");
}

/* Ø­ÙØ¸ ØªÙ„Ù‚Ø§Ø¦ÙŠ */
function saveDraft(){
  const draft = {
    name: nameInput.value,
    phone: phoneInput.value,
    area: areaInput.value,
    lat: lat,
    lng: lng
  };
  try{
    localStorage.setItem(STORAGE_KEY, JSON.stringify(draft));
  }catch(e){}
}
function restoreDraft(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return;
    const draft = JSON.parse(raw);
    if(draft && typeof draft === "object"){
      if(typeof draft.name === "string") nameInput.value = draft.name;
      if(typeof draft.phone === "string") phoneInput.value = draft.phone;
      if(typeof draft.area === "string") areaInput.value = draft.area;
      if(typeof draft.lat === "number") lat = draft.lat;
      if(typeof draft.lng === "number") lng = draft.lng;

      if(hasValidCoords()){
        document.getElementById("locationStatus").textContent="âœ”ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø¯Ù‚Ø©";
      }
    }
  }catch(e){}
}

/* Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ */
function isArabicText(s){
  const v = (s || "").trim();
  return v.length > 0 && /^[Ø¡-ÙŠ\s]+$/.test(v);
}
function isSaudiMobile(s){
  const v = (s || "").trim();
  return /^05\d{8}$/.test(v);
}

/* ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ + Ø£ÙŠÙ‚ÙˆÙ†Ø© âœ”ï¸ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… background-image ÙÙŠ CSS) */
function setValid(inputEl, box){
  inputEl.classList.add("valid");
  inputEl.classList.remove("invalid");
  if(box) box.style.display="none";
}
function setInvalid(inputEl){
  inputEl.classList.remove("valid");
}

/* ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ */
function updateSubmitState(){
  const phoneClean = phoneInput.value.replace(/\D/g,''); // Ù„Ø¶Ù…Ø§Ù† Ù…ØªØµÙ„
  const ok =
    isArabicText(nameInput.value) &&
    isSaudiMobile(phoneClean) &&
    isArabicText(areaInput.value) &&
    hasValidCoords();

  submitBtn.disabled = !ok;
}

/* ØªØ­Ù‚Ù‚ Ø´Ø§Ù…Ù„ */
function validateAll(){
  // Ø§Ù„Ø§Ø³Ù…
  if(nameInput.value.trim() === ""){
    clearErr(nameInput, errName);
    setInvalid(nameInput);
  }else if(!isArabicText(nameInput.value)){
    showErr(nameInput, errName, "Ø§Ù„Ø§Ø³Ù… ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·");
  }else{
    clearErr(nameInput, errName);
    setValid(nameInput, errName);
  }

  // Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª - Ù…ØªØµÙ„)
  const cleanedPhone = phoneInput.value.replace(/\D/g,'').slice(0,10);
  phoneInput.value = cleanedPhone; // âœ… Ù…ØªØµÙ„ Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª
  if(cleanedPhone === ""){
    clearErr(phoneInput, errPhone);
    setInvalid(phoneInput);
  }else if(cleanedPhone.length >= 2 && !cleanedPhone.startsWith("05")){
    showErr(phoneInput, errPhone, "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05");
  }else if(cleanedPhone.length === 10 && isSaudiMobile(cleanedPhone)){
    clearErr(phoneInput, errPhone);
    setValid(phoneInput, errPhone);
  }else{
    // Ù„Ø§ Ù†Ø¹ØªØ¨Ø±Ù‡ Ø®Ø·Ø£ Ù‚ÙˆÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„ 10 ÙˆØ®Ø·Ø£
    clearErr(phoneInput, errPhone);
    setInvalid(phoneInput);
  }

  // Ø§Ù„Ø­ÙŠ
  if(areaInput.value.trim() === ""){
    clearErr(areaInput, errArea);
    setInvalid(areaInput);
  }else if(!isArabicText(areaInput.value)){
    showErr(areaInput, errArea, "Ø§Ù„Ø­ÙŠ ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© ÙÙ‚Ø·");
  }else{
    clearErr(areaInput, errArea);
    setValid(areaInput, errArea);
  }

  updateSubmitState();
  saveDraft();
}

/* Ø§Ù„Ø§Ø³Ù…: Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© ÙˆÙ…Ø³Ø§ÙØ§Øª ÙÙ‚Ø· */
nameInput.addEventListener("input", function(){
  const cleaned = this.value.replace(/[^Ø¡-ÙŠ\s]/g,"");
  if(this.value !== cleaned) this.value = cleaned;
  validateAll();
});

/* Ø§Ù„Ø­ÙŠ: Ø­Ø±ÙˆÙ Ø¹Ø±Ø¨ÙŠØ© ÙˆÙ…Ø³Ø§ÙØ§Øª ÙÙ‚Ø· */
areaInput.addEventListener("input", function(){
  const cleaned = this.value.replace(/[^Ø¡-ÙŠ\s]/g,"");
  if(this.value !== cleaned) this.value = cleaned;
  validateAll();
});

/* Ø§Ù„Ø¬ÙˆØ§Ù„: Ø£Ø±Ù‚Ø§Ù… ÙÙ‚Ø· + 10 + ÙŠØ¨Ø¯Ø£ 05 + Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª */
phoneInput.addEventListener("input", function(){
  let raw = this.value.replace(/\D/g,"");
  if(raw.length > 10) raw = raw.slice(0,10);
  this.value = raw; // âœ… Ù…ØªØµÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª
  validateAll();
});

let map,marker,lat,lng;

/* ======= Ø¥Ø¶Ø§ÙØ© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¯Ù‚Ø© (Ø¬Ø¯ÙŠØ¯Ø©) ======= */
function getAccuracyLabel(accMeters){
  if(typeof accMeters !== "number") return "â„¹ï¸ Ø§Ù„Ø¯Ù‚Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©";
  if(accMeters <= 20) return "ğŸ¯ Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©";
  if(accMeters <= 50) return "ğŸ“ Ø¯Ù‚Ø© Ù…ØªÙˆØ³Ø·Ø©";
  return "âš ï¸ Ø¯Ù‚Ø© Ù…Ù†Ø®ÙØ¶Ø©";
}
function setAccuracyUI(accMeters){
  const el = document.getElementById("accuracyInfo");
  if(!el) return;
  if(typeof accMeters === "number"){
    el.textContent = `${getAccuracyLabel(accMeters)} (Â±${Math.round(accMeters)} Ù…ØªØ±)`;
  }else{
    el.textContent = getAccuracyLabel(accMeters);
  }
}
/* ======= Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ======= */

/* ======= ØªØ·ÙˆÙŠØ± openMap Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ + Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ======= */
function openMap(){
  document.getElementById("mapModal").style.display="flex";

  setTimeout(()=>{
    // Ù„Ùˆ Ø§Ù„Ø®Ø±ÙŠØ·Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©: ÙÙ‚Ø· Ø­Ø¯Ù‘Ø« Ø§Ù„Ø­Ø¬Ù… ÙˆØ±ÙƒØ² Ø¹Ù„Ù‰ Ø£Ø­Ø¯Ø« Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª
    if(map){
      map.invalidateSize();
      if(hasValidCoords() && marker){
        map.setView([lat,lng],16);
        marker.setLatLng([lat,lng]);
      }
      return;
    }

    // ØªØ­Ø¯ÙŠØ¯ Ù…Ø±ÙƒØ² Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©: Ù„Ùˆ Ù…Ø­ÙÙˆØ¸ lat/lng Ù†Ø¨Ø¯Ø£ Ø¨Ù‡ØŒ ÙˆØ¥Ù„Ø§ Ø§Ù„Ø±ÙŠØ§Ø¶
    const defaultCenter = [24.7136,46.6753];
    const startCenter = hasValidCoords() ? [lat,lng] : defaultCenter;
    const startZoom   = hasValidCoords() ? 16 : 13;

    map=L.map('map').setView(startCenter,startZoom);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    marker=L.marker(map.getCenter(),{draggable:true}).addTo(map);

    // âœ… Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ø¯Ø§Ø¦Ù…Ø§Ù‹
    marker.on("dragend", ()=>{
      const p = marker.getLatLng();
      lat = p.lat; lng = p.lng;
      document.getElementById("locationStatus").textContent="ğŸ“ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„";
      setAccuracyUI(undefined); // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙŠØ¯ÙˆÙŠ Ù„Ø§ ÙŠÙˆØ¬Ø¯ accuracy Ù…Ù† GPS
      saveDraft();
      updateSubmitState();
    });

    // âœ… Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¥Ø°Ø§ Ù…Ø§ Ø¹Ù†Ø¯Ù†Ø§ Ù…ÙˆÙ‚Ø¹ Ù…Ø­ÙÙˆØ¸
    if(!hasValidCoords()){
      locateNow();
    }else{
      document.getElementById("locationStatus").textContent="ğŸ“ ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ù…Ø­ÙÙˆØ¸ â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø¨ÙˆØ³ Ø¥Ø°Ø§ Ù„Ø²Ù…";
      setAccuracyUI(undefined);
    }
  },200);
}

/* ======= Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©: Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ø³ØªØ®Ø¯Ù… Ù…ÙˆÙ‚Ø¹ÙŠ Ø§Ù„Ø¢Ù†" ======= */
function locateNow(){
  if(!("geolocation" in navigator)){
    document.getElementById("locationStatus").textContent="âŒ Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹";
    setAccuracyUI(undefined);
    return;
  }

  document.getElementById("locationStatus").textContent="â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§...";
  setAccuracyUI(undefined);

  navigator.geolocation.getCurrentPosition(
    (pos)=>{
      lat = pos.coords.latitude;
      lng = pos.coords.longitude;

      const acc = pos.coords.accuracy;

      // Ù„Ùˆ Ø§Ù„Ø®Ø±ÙŠØ·Ø©/Ø§Ù„Ù…Ø¤Ø´Ø± Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ†
      if(map){
        map.setView([lat,lng],16);
      }
      if(marker){
        marker.setLatLng([lat,lng]);
      }

      document.getElementById("locationStatus").textContent="âœ”ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ â€” ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¯Ø¨ÙˆØ³ Ø¥Ø°Ø§ Ù„Ø²Ù…";
      setAccuracyUI(acc);

      saveDraft();
      updateSubmitState();
    },
    (err)=>{
      console.warn("Geolocation error:", err && err.message ? err.message : err);
      document.getElementById("locationStatus").textContent="âš ï¸ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ÙƒØŒ ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯Ù‡ ÙŠØ¯ÙˆÙŠÙ‹Ø§";
      setAccuracyUI(undefined);
    },
    {
      enableHighAccuracy:true,
      timeout:10000,
      maximumAge:0
    }
  );
}
/* ======= Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ======= */

function confirmLocation(){
  const p=marker.getLatLng();
  lat=p.lat; lng=p.lng;
  document.getElementById("locationStatus").textContent="âœ”ï¸ ØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ø¯Ù‚Ø©";
  document.getElementById("mapModal").style.display="none";
  saveDraft();         // ğŸ”’ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆÙ‚Ø¹
  updateSubmitState(); // âœ… ØªÙØ¹ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ø°Ø§ Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
}

/* âœ… Ù‚ÙÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ÙƒØ±Ø± */
let __sending = false;

function submitForm(){

  if(__sending) return;
  __sending = true;

  const inputs = document.querySelectorAll("#formModal input");

  const data = {
    name: inputs[0].value.trim(),
    phone: inputs[1].value.trim(),
    area: inputs[2].value.trim(),
    lat: lat,
    lng: lng,
    source: "Ø§Ù„Ù…ÙˆÙ‚Ø¹",
    notes: ""
  };

  // âœ… ØªØ£ÙƒÙŠØ¯ Ø£Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ù…ØªØµÙ„ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ§Øª
  data.phone = data.phone.replace(/\D/g,'').slice(0,10);

  // ØªØ­Ù‚Ù‚ Ø¨Ø³ÙŠØ· (Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ Ù…ÙˆØ¬ÙˆØ¯ - Ù„Ù… ÙŠÙØ­Ø°Ù)
  if(!data.name || !data.phone || !data.area){
    validateAll();
    __sending = false;
    return;
  }

  const phoneRegex = /^05\d{8}$/;
  if(!phoneRegex.test(data.phone)){
    validateAll();
    showErr(phoneInput, errPhone, "Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ­ÙŠØ­ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ¨Ø¯Ø£ Ø¨Ù€ 05 ÙˆÙŠØªÙƒÙˆÙ† Ù…Ù† 10 Ø£Ø±Ù‚Ø§Ù…");
    __sending = false;
    return;
  }

  if(!Number.isFinite(Number(data.lat)) || !Number.isFinite(Number(data.lng))){
    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©");
    __sending = false;
    return;
  }

  // Ø±Ø§Ø¨Ø· Web App (Ù†ÙØ³ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªØ®Ø¯Ù…ØªÙ‡ ÙÙŠ Postman)
  const WEB_APP_URL = "/api/donate?debug=1";

  // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø²Ø± Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±
  const btns = document.querySelectorAll(".submit");
  btns.forEach(b => b.disabled = true);

  fetch(WEB_APP_URL, {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    cache: "no-store",
    body: JSON.stringify(data)
  })
  .then(async (res) => {
    const text = await res.text();
    let json = null;
    try{ json = JSON.parse(text); }catch(e){}

    console.log("[donate] http:", res.status);
    console.log("[donate] raw:", text);
    console.log("[donate] json:", json);

    if(!res.ok){
      throw new Error(json?.error || json?.message || `HTTP ${res.status}`);
    }
    return json;
  })
  .then(res => {
    console.log("[donate] final response:", res);

    const okFlag = res && (res.success === true || res.ok === true);
    const hasId  = res && typeof res.requestId === "string" && res.requestId.trim().length > 0;
    const markerOk = !res?.marker || res.marker === EXPECTED_GAS_MARKER;

    if(!okFlag || !hasId || !markerOk){
      if(res?._debug) console.log("[donate] _debug:", res._debug);
      const msg =
        res?.error ||
        res?.message ||
        (!markerOk ? "âš ï¸ Ø£Ù†Øª ØªØ¶Ø±Ø¨ Deploy Ù…Ø®ØªÙ„Ù (marker ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚)" : "") ||
        (!hasId ? "âš ï¸ ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ù†Ø¬Ø§Ø­ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… Ø·Ù„Ø¨ (requestId) â€” Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø­ÙØ¸" : "") ||
        "ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„";
      throw new Error(msg);
    }

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø­ÙØ¸ Ø¨Ø¹Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    try{ localStorage.removeItem(STORAGE_KEY); }catch(e){}

    document.querySelector("#formModal .modal-box").innerHTML =
      `Ø¬Ø²Ø§Ùƒ Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ù‹Ø§ ğŸŒ·<br>
       ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…<br>
       <div style="margin-top:10px;font-weight:900;color:#34d399">Ø±Ù‚Ù… Ø§Ù„Ø·Ù„Ø¨: ${res.requestId}</div>
       <div style="margin-top:10px;opacity:.85">Ø³ÙŠØªÙ… Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹Ùƒ Ù‚Ø±ÙŠØ¨Ù‹Ø§ Ø¨Ø¥Ø°Ù† Ø§Ù„Ù„Ù‡.</div>
       <br>Ø³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„Ùƒ Ø§Ù„Ø¢Ù† Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ù…Ø¹ÙŠØ©...`;

    // ğŸ¯ ØªÙˆØ¬ÙŠÙ‡ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
    setTimeout(()=>{
      window.location.href = "https://rafah.org.sa";
    }, 2000);
  })
  .catch(err => {
    alert(err && err.message ? err.message : "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
    console.error(err);
    btns.forEach(b => b.disabled = false);
    updateSubmitState();
  })
  .finally(()=>{
    __sending = false;
  });
}
  /* ===== Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ===== */
function openConfirmModal(){
  // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ£ÙƒÙŠØ¯
  document.getElementById("cName").textContent  = nameInput.value;
  document.getElementById("cPhone").textContent = phoneInput.value;
  document.getElementById("cArea").textContent  = areaInput.value;

  document.getElementById("confirmModal").style.display = "flex";
}

function closeConfirm(){
  document.getElementById("confirmModal").style.display = "none";
}

/* Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ¹Ù„ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒÙŠØ¯ */
function confirmSubmit(){
  closeConfirm();
  submitForm(); // Ù†ÙØ³ Ø¯Ø§Ù„Ø© Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ±
}
</script>
<!-- Ù†Ø§ÙØ°Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
<div class="modal" id="confirmModal">
  <div class="modal-box">
    <h3 style="margin-top:0;text-align:center">ØªØ£ÙƒÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨</h3>

    <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> <span id="cName"></span></p>
    <p><strong>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„:</strong> <span id="cPhone"></span></p>
    <p><strong>Ø§Ù„Ø­ÙŠ:</strong> <span id="cArea"></span></p>

    <button class="submit" onclick="closeConfirm()">âŒ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    <button class="submit" onclick="confirmSubmit()">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</button>
  </div>
</div>

</body>
</html>
